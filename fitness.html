<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é‹å‹•è¨˜éŒ„å™¨ V3</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 400px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 25px;
            text-align: center;
            position: relative;
        }

        h1 { margin-top: 0; font-size: 1.5rem; color: #2c3e50; }
        .date { color: #888; font-size: 0.9rem; margin-bottom: 15px; font-weight: bold; }

        /* é ‚éƒ¨å·¥å…·åˆ— */
        .toolbar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .btn-tool {
            background: #fff;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            color: #555;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* é‹å‹•é …ç›®é¸æ“‡å€ */
        .select-group { margin-bottom: 20px; }
        select {
            width: 100%;
            padding: 12px;
            font-size: 1.1rem;
            border-radius: 10px;
            border: 2px solid #eee;
            background-color: #fff;
        }

        /* é¡¯ç¤ºå¤§æ•¸å­— */
        .counter-display {
            font-size: 4.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 5px 0;
            line-height: 1;
        }
        .unit { font-size: 1rem; color: #666; margin-bottom: 20px;}

        /* æŒ‰éˆ•å€åŸŸ */
        .btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        button {
            border: none;
            padding: 15px 0;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
            touch-action: manipulation;
        }
        button:active { transform: scale(0.95); }

        .btn-add { background-color: #e3f2fd; color: #1565c0; }
        
        /* è‡ªå®šç¾©è¼¸å…¥å€ */
        .custom-input-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        input {
            flex: 1;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 1rem;
        }
        
        .btn-confirm { background-color: var(--primary-color); color: white; padding: 0 20px; }
        
        /* Modal é€šç”¨æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            width: 85%;
            max-width: 350px;
            text-align: left;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .modal-header { font-weight: bold; margin-bottom: 15px; display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 10px;}
        .close-modal { cursor: pointer; font-size: 1.5rem; line-height: 1; color: #888; }
        
        /* æ­·å²ç´€éŒ„æ¨£å¼ */
        .history-list, .manage-list {
            list-style: none;
            padding: 0;
            overflow-y: auto;
            margin: 0;
        }
        .history-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 12px 0;
        }
        .history-date { font-weight: bold; color: #333; font-size: 0.95rem; margin-bottom: 5px; }
        .history-detail { font-size: 0.85rem; color: #666; line-height: 1.4; }
        .no-data { text-align: center; color: #999; padding: 20px; }

        /* ç®¡ç†åˆ—è¡¨æ¨£å¼ */
        .manage-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .btn-delete-item {
            background: #ffebee; color: #d32f2f; padding: 5px 10px; font-size: 0.8rem; border-radius: 5px;
        }
        .add-new-group { display: flex; gap: 5px; margin-top: 15px;}
        .btn-create { background: var(--success-color); color: white; font-size: 0.9rem; padding: 0 15px; }

    </style>
</head>
<body>

<div class="container">
    <div class="toolbar">
        <button class="btn-tool" onclick="openHistoryModal()">ğŸ“œ æ­·å²ç´€éŒ„</button>
        <button class="btn-tool" onclick="openManageModal()">âš™ï¸ è¨­å®šé …ç›®</button>
    </div>

    <h1>ä»Šæ—¥é‹å‹•</h1>
    <div class="date" id="currentDate">--/--</div>

    <div class="select-group">
        <select id="exerciseType" onchange="changeExercise()">
            </select>
    </div>

    <div class="counter-display" id="countDisplay">0</div>
    <div class="unit">æ¬¡æ•¸ / çµ„æ•¸ / ç§’æ•¸</div>

    <div class="btn-grid">
        <button class="btn-add" onclick="addCount(1)">+1</button>
        <button class="btn-add" onclick="addCount(5)">+5</button>
        <button class="btn-add" onclick="addCount(10)">+10</button>
    </div>

    <div class="custom-input-group">
        <input type="number" id="customInput" placeholder="è¼¸å…¥æ•¸å­—" inputmode="numeric">
        <button class="btn-confirm" onclick="addCustom()">åŠ å…¥</button>
    </div>
</div>

<div id="historyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>éå¾€ç´€éŒ„</span>
            <span class="close-modal" onclick="closeHistoryModal()">&times;</span>
        </div>
        <ul class="history-list" id="historyList">
            </ul>
        <div style="margin-top:10px; text-align:right;">
             <button onclick="clearHistory()" style="background:none; color:#999; font-size:0.8rem; padding:5px;">æ¸…ç©ºæ­·å²</button>
        </div>
    </div>
</div>

<div id="manageModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>ç·¨è¼¯é‹å‹•é …ç›®</span>
            <span class="close-modal" onclick="closeManageModal()">&times;</span>
        </div>
        <ul class="manage-list" id="manageList">
            </ul>
        <div class="add-new-group">
            <input type="text" id="newExerciseName" placeholder="æ–°é‹å‹•åç¨±">
            <button class="btn-create" onclick="createNewExercise()">æ–°å¢</button>
        </div>
    </div>
</div>

<script>
    // --- è®Šæ•¸èˆ‡åˆå§‹åŒ– ---
    const defaultExercises = ['ä¼åœ°æŒºèº«', 'æ·±è¹²', 'å¹³æ¿æ”¯æ’(ç§’)'];
    let exercises = []; 
    let records = {};   
    let historyData = []; // æ­·å²ç´€éŒ„é™£åˆ—
    let currentExercise = '';

    window.onload = function() {
        // 1. å…ˆè™•ç†æ—¥æœŸèˆ‡æ­¸é›¶é‚è¼¯
        checkDateAndReset();

        // 2. æ¸²æŸ“ç•«é¢
        const today = new Date();
        document.getElementById('currentDate').innerText = `${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
        
        loadData();
        renderSelectOptions();
        updateDisplay();
    };

    // --- æ ¸å¿ƒé‚è¼¯ï¼šæ›æ—¥æª¢æ¸¬ ---
    function checkDateAndReset() {
        const todayStr = new Date().toDateString(); // ä¾‹å¦‚ "Sat Oct 28 2023"
        const lastActiveDate = localStorage.getItem('fitness_last_date');

        // å¦‚æœä¸Šæ¬¡ä½¿ç”¨çš„æ—¥æœŸå­˜åœ¨ï¼Œä¸”ä¸ç­‰æ–¼ä»Šå¤© (ä»£è¡¨è·¨æ—¥äº†)
        if (lastActiveDate && lastActiveDate !== todayStr) {
            
            // è®€å–ç•¶ä¸‹çš„ç´€éŒ„ (é€™å…¶å¯¦æ˜¯æ˜¨å¤©çš„ç´€éŒ„)
            const oldRecordsStr = localStorage.getItem('fitness_records');
            if (oldRecordsStr) {
                const oldRecords = JSON.parse(oldRecordsStr);
                
                // æª¢æŸ¥æ˜¯å¦æœ‰æ•¸æ“šï¼Œå…¨éƒ¨æ˜¯ 0 å°±ä¸å­˜äº†
                const hasData = Object.values(oldRecords).some(val => val > 0);
                
                if (hasData) {
                    // å­˜å…¥æ­·å²
                    const historyStr = localStorage.getItem('fitness_history') || '[]';
                    let history = JSON.parse(historyStr);
                    
                    // æŠŠèˆŠç´€éŒ„å¡åˆ°é™£åˆ—æœ€å‰é¢ (æœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
                    history.unshift({
                        date: formatDate(new Date(lastActiveDate)), // è½‰æˆæ˜“è®€æ ¼å¼
                        data: oldRecords
                    });

                    // å„²å­˜æ­·å²
                    localStorage.setItem('fitness_history', JSON.stringify(history));
                }
            }

            // æ¸…ç©ºä»Šæ—¥ç´€éŒ„
            // é€™è£¡æˆ‘å€‘ä¸åˆªé™¤ keyï¼ŒåªæŠŠ value è¨­ç‚º 0ï¼Œé¿å…é …ç›®æ¶ˆå¤±
            let currentRecs = JSON.parse(oldRecordsStr || '{}');
            for (let key in currentRecs) {
                currentRecs[key] = 0;
            }
            localStorage.setItem('fitness_records', JSON.stringify(currentRecs));
        }

        // æ›´æ–°ã€Œæœ€å¾Œä½¿ç”¨æ—¥æœŸã€ç‚ºä»Šå¤©
        localStorage.setItem('fitness_last_date', todayStr);
    }

    function formatDate(dateObj) {
        return `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
    }

    // --- è³‡æ–™è®€å–èˆ‡å„²å­˜ ---
    function loadData() {
        // é …ç›®åˆ—è¡¨
        const savedExercises = localStorage.getItem('fitness_exercises');
        exercises = savedExercises ? JSON.parse(savedExercises) : [...defaultExercises];

        // ä»Šæ—¥ç´€éŒ„
        const savedRecords = localStorage.getItem('fitness_records');
        records = savedRecords ? JSON.parse(savedRecords) : {};

        // æ­·å²ç´€éŒ„
        const savedHistory = localStorage.getItem('fitness_history');
        historyData = savedHistory ? JSON.parse(savedHistory) : [];

        // è£œé½Šç¼ºå°‘çš„ key (é˜²å‘†)
        exercises.forEach(ex => {
            if (records[ex] === undefined) records[ex] = 0;
        });

        if (exercises.length > 0 && !currentExercise) {
            currentExercise = exercises[0];
        }
    }

    function saveData() {
        localStorage.setItem('fitness_exercises', JSON.stringify(exercises));
        localStorage.setItem('fitness_records', JSON.stringify(records));
        localStorage.setItem('fitness_history', JSON.stringify(historyData));
    }

    // --- ä¸»ç•«é¢æ“ä½œ ---
    function renderSelectOptions() {
        const select = document.getElementById('exerciseType');
        select.innerHTML = '';
        exercises.forEach(ex => {
            const option = document.createElement('option');
            option.value = ex;
            option.text = ex;
            select.appendChild(option);
        });
        
        if (exercises.includes(currentExercise)) {
            select.value = currentExercise;
        } else if (exercises.length > 0) {
            select.value = exercises[0];
            currentExercise = exercises[0];
        }
    }

    function changeExercise() {
        currentExercise = document.getElementById('exerciseType').value;
        updateDisplay();
    }

    function addCount(amount) {
        if (!currentExercise) return;
        records[currentExercise] += amount;
        saveData();
        updateDisplay();
    }

    function addCustom() {
        if (!currentExercise) return;
        const input = document.getElementById('customInput');
        const val = parseInt(input.value);
        if (!isNaN(val) && val > 0) {
            addCount(val);
            input.value = '';
        }
    }

    function updateDisplay() {
        const display = document.getElementById('countDisplay');
        if (exercises.length === 0) {
            display.innerText = '-';
            return;
        }
        display.innerText = records[currentExercise];
        display.style.transform = "scale(1.1)";
        setTimeout(() => display.style.transform = "scale(1)", 150);
    }

    // --- æ­·å²ç´€éŒ„ Modal ---
    function openHistoryModal() {
        document.getElementById('historyModal').style.display = 'flex';
        renderHistoryList();
    }
    function closeHistoryModal() {
        document.getElementById('historyModal').style.display = 'none';
    }
    
    function renderHistoryList() {
        const list = document.getElementById('historyList');
        list.innerHTML = '';

        if (historyData.length === 0) {
            list.innerHTML = '<li class="no-data">ç›®å‰é‚„æ²’æœ‰æ­·å²ç´€éŒ„<br>(éäº†åˆå¤œå¾Œæ˜¨å¤©çš„ç´€éŒ„å°±æœƒå‡ºç¾åœ¨é€™)</li>';
            return;
        }

        historyData.forEach(item => {
            const li = document.createElement('li');
            li.className = 'history-item';
            
            // æ•´ç†æ•¸æ“šé¡¯ç¤ºå­—ä¸²ï¼Œéæ¿¾æ‰ 0 çš„é …ç›®
            let detailText = [];
            for (let [key, val] of Object.entries(item.data)) {
                if (val > 0) {
                    detailText.push(`${key}: ${val}`);
                }
            }
            
            li.innerHTML = `
                <div class="history-date">${item.date}</div>
                <div class="history-detail">${detailText.join(' ,  ') || 'ç„¡é‹å‹•ç´€éŒ„'}</div>
            `;
            list.appendChild(li);
        });
    }

    function clearHistory() {
        if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ­·å²ç´€éŒ„å—ï¼Ÿç„¡æ³•å¾©åŸå–”ï¼')) {
            historyData = [];
            saveData();
            renderHistoryList();
        }
    }

    // --- ç®¡ç†é …ç›® Modal ---
    function openManageModal() {
        document.getElementById('manageModal').style.display = 'flex';
        renderManageList();
    }
    function closeManageModal() {
        document.getElementById('manageModal').style.display = 'none';
    }

    function renderManageList() {
        const list = document.getElementById('manageList');
        list.innerHTML = '';
        exercises.forEach((ex) => {
            const li = document.createElement('li');
            li.className = 'manage-item';
            li.innerHTML = `<span>${ex}</span> <button class="btn-delete-item" onclick="deleteExercise('${ex}')">åˆªé™¤</button>`;
            list.appendChild(li);
        });
    }

    function createNewExercise() {
        const input = document.getElementById('newExerciseName');
        const name = input.value.trim();
        if (!name) return alert('è«‹è¼¸å…¥åç¨±');
        if (exercises.includes(name)) return alert('å·²å­˜åœ¨');

        exercises.push(name);
        records[name] = 0;
        saveData();
        
        currentExercise = name; 
        renderSelectOptions();
        renderManageList(); 
        updateDisplay();
        input.value = '';
    }

    function deleteExercise(name) {
        if(!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€ï¼Ÿ`)) return;
        exercises = exercises.filter(item => item !== name);
        delete records[name];
        saveData();
        
        // å¦‚æœåˆªé™¤äº†ç•¶å‰é¸ä¸­çš„ï¼Œåˆ‡æ›åˆ°åˆ¥çš„
        if (currentExercise === name) {
            currentExercise = exercises[0] || '';
        }
        
        renderSelectOptions();
        renderManageList();
        updateDisplay();
    }

    // é»æ“Šå¤–éƒ¨é—œé–‰
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    }
</script>

</body>
</html>